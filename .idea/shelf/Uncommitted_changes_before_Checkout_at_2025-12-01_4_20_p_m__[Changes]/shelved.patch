Index: app/src/main/java/com/example/smartair/child_managent/AddChildActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.smartair.child_managent;\r\n\r\nimport android.app.DatePickerDialog;\r\nimport android.content.Intent;\r\nimport android.os.Bundle;\r\nimport android.widget.EditText;\r\nimport android.widget.TextView;\r\nimport android.widget.Toast;\r\n\r\nimport androidx.appcompat.app.AppCompatActivity;\r\n\r\nimport com.example.smartair.R;\r\nimport com.example.smartair.utils.SharedPrefsHelper;\r\nimport com.google.firebase.auth.FirebaseAuth;\r\nimport com.google.firebase.auth.FirebaseUser;\r\nimport com.google.firebase.firestore.DocumentReference;\r\nimport com.google.firebase.firestore.FieldValue;\r\nimport com.google.firebase.firestore.FirebaseFirestore;\r\nimport com.google.firebase.firestore.WriteBatch;\r\n\r\nimport java.util.Calendar;\r\nimport java.util.HashMap;\r\nimport java.util.Map;\r\n\r\npublic class AddChildActivity extends AppCompatActivity {\r\n\r\n    private EditText editChildUsername, editChildPassword, editChildName, editChildNotes, editChildDOB;\r\n    private TextView textGreeting;\r\n    private String selectedDOB = \"\";\r\n\r\n    private FirebaseAuth auth;\r\n    private FirebaseFirestore db;\r\n    private int cnt = 0;\r\n    String parentId;\r\n\r\n    @Override\r\n    protected void onCreate(Bundle savedInstanceState) {\r\n        super.onCreate(savedInstanceState);\r\n        setContentView(R.layout.activity_add_child);\r\n\r\n        auth = FirebaseAuth.getInstance();\r\n        db = FirebaseFirestore.getInstance();\r\n\r\n        FirebaseUser parent = auth.getCurrentUser();\r\n        if (parent == null) {\r\n            Toast.makeText(this, \"Please log in first.\", Toast.LENGTH_SHORT).show();\r\n            finish();\r\n            return;\r\n        }\r\n\r\n        textGreeting = findViewById(R.id.textGreeting);\r\n        editChildUsername = findViewById(R.id.editChildUsername);\r\n        editChildPassword = findViewById(R.id.editChildPassword);\r\n        editChildName = findViewById(R.id.editChildName);\r\n        editChildNotes = findViewById(R.id.editChildNotes);\r\n        editChildDOB = findViewById(R.id.editChildDOB);\r\n\r\n        editChildDOB.setOnClickListener(v -> showDatePickerDialog());\r\n\r\n        findViewById(R.id.btnAddChild).setOnClickListener(v -> checkUsernameAndAddChild());\r\n\r\n        loadParentName(parent.getUid());\r\n    }\r\n\r\n    private void loadParentName(String uid) {\r\n        db.collection(\"users\").document(uid).get()\r\n                .addOnSuccessListener(doc -> {\r\n                    if (doc.exists()) {\r\n                        String name = doc.getString(\"name\");\r\n                        if (name != null && !name.isEmpty()) {\r\n                            textGreeting.setText(\"Hello, \" + name);\r\n                        }\r\n                    }\r\n                });\r\n    }\r\n\r\n    private void showDatePickerDialog() {\r\n        Calendar c = Calendar.getInstance();\r\n        int year = c.get(Calendar.YEAR);\r\n        int month = c.get(Calendar.MONTH);\r\n        int day = c.get(Calendar.DAY_OF_MONTH);\r\n\r\n        DatePickerDialog dialog = new DatePickerDialog(\r\n                this,\r\n                (view, yr, mo, dy) -> {\r\n                    selectedDOB = String.format(\"%02d/%02d/%d\", dy, mo + 1, yr);\r\n                    editChildDOB.setText(selectedDOB);\r\n                },\r\n                year, month, day\r\n        );\r\n        dialog.getDatePicker().setMaxDate(System.currentTimeMillis());\r\n        dialog.show();\r\n    }\r\n\r\n    private void checkUsernameAndAddChild() {\r\n        String username = editChildUsername.getText().toString().trim();\r\n        String password = editChildPassword.getText().toString().trim();\r\n        String name = editChildName.getText().toString().trim();\r\n        String dob = selectedDOB;\r\n        String notes = editChildNotes.getText().toString().trim();\r\n\r\n        if (username.isEmpty() || password.isEmpty() || name.isEmpty() || dob.isEmpty()) {\r\n            Toast.makeText(this, \"All fields required.\", Toast.LENGTH_SHORT).show();\r\n            return;\r\n        }\r\n\r\n        // 检查 username 是否存在\r\n        DocumentReference usernameRef = db.collection(\"usernames\").document(username);\r\n        usernameRef.get().addOnSuccessListener(doc -> {\r\n            if (doc.exists()) {\r\n                Toast.makeText(this, \"Username already exists.\", Toast.LENGTH_LONG).show();\r\n            } else {\r\n                createChildFirebaseAuth(username, password, name, dob, notes);\r\n            }\r\n        });\r\n    }\r\n\r\n    private void createChildFirebaseAuth(String username, String password, String name, String dob, String notes) {\r\n        String email = username + \"@child.smartair.com\";\r\n\r\n        // Save parent UID BEFORE Firebase logs them out\r\n        if (cnt == 0) {\r\n            parentId = auth.getCurrentUser().getUid();\r\n            cnt++;\r\n        }\r\n\r\n        String parentEmail = SharedPrefsHelper.getString(this, \"PARENT_EMAIL\");\r\n        String parentPassword = SharedPrefsHelper.getString(this, \"PARENT_PASSWORD\");\r\n\r\n        if (parentEmail == null || parentPassword == null) {\r\n            Toast.makeText(this, \"Parent login info missing. Please log in again.\", Toast.LENGTH_LONG).show();\r\n            return;\r\n        }\r\n\r\n        auth.createUserWithEmailAndPassword(email, password)\r\n                .addOnSuccessListener(authResult -> {\r\n\r\n                    String childUid = authResult.getUser().getUid();\r\n\r\n                    auth.signInWithEmailAndPassword(parentEmail, parentPassword)\r\n\r\n\r\n                            .addOnSuccessListener(parentLoginResult -> {\r\n\r\n\r\n\r\n\r\n\r\n                                saveChildFirestore(parentId, childUid, username, email, name, dob, notes, password);\r\n\r\n\r\n\r\n\r\n\r\n                            })\r\n\r\n\r\n                            .addOnFailureListener(e -> {\r\n\r\n\r\n                                Toast.makeText(this, \"Failed to log parent back in: \" + e.getMessage(), Toast.LENGTH_LONG).show();\r\n\r\n\r\n                            });\r\n\r\n                })\r\n                .addOnFailureListener(e -> {\r\n                    Toast.makeText(this, \"Failed to create child account: \" + e.getMessage(), Toast.LENGTH_SHORT).show();\r\n                });\r\n    }\r\n\r\n\r\n\r\n    private void saveChildFirestore(String parentId, String childUid, String username, String email,\r\n                                    String name, String dob, String notes, String password) {\r\n\r\n        WriteBatch batch = db.batch();\r\n\r\n        DocumentReference childRef = db.collection(\"users\")\r\n                .document(parentId)\r\n                .collection(\"children\")\r\n                .document(childUid);\r\n\r\n        Map<String, Object> childData = new HashMap<>();\r\n        childData.put(\"uid\", childUid);\r\n        childData.put(\"username\", username);\r\n        childData.put(\"email\", email);\r\n        childData.put(\"password\", password);\r\n        childData.put(\"name\", name);\r\n        childData.put(\"dob\", dob);\r\n        childData.put(\"notes\", notes);\r\n        childData.put(\"role\", \"child\");\r\n        childData.put(\"createdAt\", FieldValue.serverTimestamp());\r\n\r\n        DocumentReference usernameRef = db.collection(\"usernames\").document(username);\r\n        Map<String, Object> usernameMap = new HashMap<>();\r\n        usernameMap.put(\"childUid\", childUid);\r\n        usernameMap.put(\"parentId\", parentId);\r\n        usernameMap.put(\"email\", email);\r\n\r\n        batch.set(childRef, childData);\r\n        batch.set(usernameRef, usernameMap);\r\n\r\n        batch.commit()\r\n                .addOnSuccessListener(unused -> {\r\n                    Toast.makeText(this, \"Child account created successfully!\", Toast.LENGTH_SHORT).show();\r\n\r\n                    // 直接回到 ChooseChildForSharingActivity，传父母 UID\r\n                    Intent intent = new Intent(AddChildActivity.this, ChooseChildForSharingActivity.class);\r\n                    intent.putExtra(\"parentId\", parentId);\r\n                    startActivity(intent);\r\n\r\n                    finish();\r\n                })\r\n                .addOnFailureListener(e -> {\r\n                    Toast.makeText(this, \"Failed to save Firestore data: \" + e.getMessage(), Toast.LENGTH_SHORT).show();\r\n                });\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/smartair/child_managent/AddChildActivity.java b/app/src/main/java/com/example/smartair/child_managent/AddChildActivity.java
--- a/app/src/main/java/com/example/smartair/child_managent/AddChildActivity.java	(revision ad1b64c3bb412fd4a8cfa4755c6e344a2aac63a2)
+++ b/app/src/main/java/com/example/smartair/child_managent/AddChildActivity.java	(date 1764623606370)
@@ -137,32 +137,8 @@
 
                     String childUid = authResult.getUser().getUid();
 
-                    auth.signInWithEmailAndPassword(parentEmail, parentPassword)
-
-
-                            .addOnSuccessListener(parentLoginResult -> {
-
-
-
-
-
-                                saveChildFirestore(parentId, childUid, username, email, name, dob, notes, password);
+                    saveChildFirestore(parentId, childUid, username, email, name, dob, notes, password);
 
-
-
-
-
-                            })
-
-
-                            .addOnFailureListener(e -> {
-
-
-                                Toast.makeText(this, "Failed to log parent back in: " + e.getMessage(), Toast.LENGTH_LONG).show();
-
-
-                            });
-
                 })
                 .addOnFailureListener(e -> {
                     Toast.makeText(this, "Failed to create child account: " + e.getMessage(), Toast.LENGTH_SHORT).show();
@@ -216,4 +192,4 @@
                     Toast.makeText(this, "Failed to save Firestore data: " + e.getMessage(), Toast.LENGTH_SHORT).show();
                 });
     }
-}
+}
\ No newline at end of file
